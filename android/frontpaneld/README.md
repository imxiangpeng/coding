---
title: 关于 frontpaneld 模块说明
author: Alex Meng
date: November 2021
---

# 关于 frontpaneld 模块说明

## 背景

STB6252C 有三个前面板独立 GPIO 按键：

1. POWER: adc channel

   这个也是 MTK 默认的待机键，目前读取方式是在 DTS 中配置 `adc-keys`

2. UP / DOWN: 这两个按键比较简单，直接连接到 CPU 端 GPIO 上面

   目前我们是通过 `gpio_keys_polled` 来驱动的。

因我们仅有两个按键，世新客户认为不能满足他们需求，他们需要在遥控器不能使用情况下，仍然可以通过前面板进行操作；

后来与客户协商，采用组合键的方式来处理，具体需求参考： http://mcv.inspur.com:8080/issues/68051

> 对于该需求也只能呵呵了，前面板本身就比较鸡肋，而且 ATV 项目，离开遥控器或者蓝牙遥控器失去很大的意义；

## 实现

这里需要注意，拿到这个需求，很可能要考虑重新实现驱动了。

这里注意，我没有修改底层驱动任何东西，采用了屏蔽 Android 接收前面板设备按键以及实现一个小模块接收前面板按键，
然后进行映射转换后再通过 `uinput` 发送出去；

> 当然这样实现也是有局限性的，例如仅在 Android 系统下有效；

1. Andorid 按键屏蔽方式

   这里我们用到了 `kl` 来处理该问题，我们只需要新建 `gpio_keys_polled.kl` 以及 `adc-keys.kl` 并且保持空白内容就可以了；

   这个时候通过 `dumpsys input` 查看，可以看到对应的设备已经使用我们的 `kl` 文件了，这个时候按键， Android 也不会给出响应了；

2. 按键转换

   这部分包含三个小模块：

   a. 从指定设备接收按键

      因为我们前面板按键来源有两个 `gpio_keys_polled` 以及 `adc-keys` 我们需要读取这两个设备的按键；

      这部分我们参考了 `getevent` 的实现；

      > 代码在 system/core/toolbox/getevent.c
      >
      > 我们使用的版本很老了还是之前 hisi 4.4 做按键指示灯的代码

   b. 按键映射

      因为默认我们的按键从左到右分别为： DOWN 、UP 、POWER

      而客户期望的按键是： UP 、DOWN 、ENTER

      为了不修改底层任何代码，我们这里需要做一个映射，将收到的按键，简单转换后再发出去；

   c. 组合键处理

      上面说了，我们需要支持两个按键同时按下，所以我们在收到按键后会有一个延迟处理，以等待用户两个按键都按下！

      > 现在这个默认延迟设置为 400ms 可以通过对应宏进行修改 COMBINATION_KEY_TIMEOUT_MS

## 特别说明

1. 只有在同时按下的按键才会被认为是组合键；

   这里允许有 400ms 的误差；

   > 也就是为了兼容这个，所以单个按键其实也是被延迟 400ms 后处理的，所以按键灵敏度上是有问题的。

2. 什么时候释放组合键

   我们期望的是用户同时按下组合键，也同时释放组合键；

   但是用户的行为我们是不可琢磨的，万一两个按键的释放间隔超过了400ms 会出现什么情况？

   这就会导致按下的组合键，不会被释放！

   所以对于该问题的处理，有两种方案：

   a. 当第一个按键释放时，在 400ms 内第二个按键都没有释放，那么继续保持第一个按键在 pending 队列中，直到匹配的组合按键都释放，才释放组合键的 UP 事件；

   b. 在组合键按下时，有任何按键的释放都直接触发组合键的 UP 事件，并且消耗掉该按键

      注意，我们前面有对按键状态的判断，一旦按键处于释放（UP）状态，那么再过来的任何按键的 UP 事件都会被忽略；

      所以当后面其他按键再松开时，事件就会被忽略掉，并不会将另一个按键的 UP 事件发出去；

3. 这里提到的延迟目前设置是 400ms，注意该值也不能太大，否则 android 会认为长按派发 repeate 事件

## 注意

需要注意的是在添加该模块后，一定要将对应的 `kl` 文件拷贝到系统中，不然会出现按键混乱现象；

